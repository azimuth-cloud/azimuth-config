name: Azimuth CI tests
description: Tests an Azimuth environment using the CI config.
runs:
  using: composite
  steps:
    - name: Check expected alerts are pending or firing
      shell: bash
      # Make sure to source the ci environment before running the tests
      run: |
        set -e
        source ./ci.env
        source ./bin/activate $AZIMUTH_CONFIG_ENVIRONMENT $AZIMUTH_ENVIRONMENT
        ./bin/check-alerts

    - name: Generate test suite
      shell: bash
      # Make sure to source the ci environment before running the provision
      run: |
        set -e
        source ./ci.env
        source ./bin/activate "$AZIMUTH_CONFIG_ENVIRONMENT" "$AZIMUTH_ENVIRONMENT"
        ansible-playbook stackhpc.azimuth_ops.generate_tests -e @extra-vars.yml
      env:
        ANSIBLE_FORCE_COLOR: "true"
